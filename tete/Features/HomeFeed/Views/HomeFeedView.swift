//======================================================================
// MARK: - HomeFeedView.swift
// Purpose: Main feed displaying posts in grid or single view („Ç∞„É™„ÉÉ„Éâ„Åæ„Åü„ÅØ„Ç∑„É≥„Ç∞„É´„Éì„É•„Éº„ÅßÊäïÁ®ø„ÇíË°®Á§∫„Åô„Çã„É°„Ç§„É≥„Éï„Ç£„Éº„Éâ)
// Path: tete/Features/HomeFeed/Views/HomeFeedView.swift
//======================================================================
import SwiftUI
import Combine

@MainActor
struct HomeFeedView: View {
    @StateObject private var viewModel = HomeFeedViewModel()
    @Binding var showGridMode: Bool
    @Binding var showingCreatePost: Bool
    @Binding var isInSingleView: Bool
    let onBackToGrid: (() -> Void)?
    @State private var headerOffset: CGFloat = 0
    @State private var selectedPost: Post?
    @State private var navigateToSingleView: Bool = false
    @Environment(\.dismiss) private var dismiss
    
    private let headerHeight: CGFloat = 56
    
    var body: some View {
        ZStack(alignment: .top) {
            // Content
            ScrollViewReader { proxy in
                ScrollView {
                    LazyVStack(spacing: 0) {
                        // Scroll tracking - „Çà„Çä‰ø°È†ºÊÄß„ÅÆÈ´ò„ÅÑÊñπÊ≥ï
                        GeometryReader { geometry in
                            Color.clear
                                .onChange(of: geometry.frame(in: .named("scroll")).minY) { _, newValue in
                                    updateHeaderOffset(scrollOffset: newValue)
                                }
                        }
                        .frame(height: 1)
                        .id("scrollTracker")
                    // Header space
                    Color.clear
                        .frame(height: headerHeight)
                    
                    if viewModel.isLoading {
                        ProgressView("Loading...")
                            .frame(maxWidth: .infinity, maxHeight: .infinity)
                    } else if viewModel.posts.isEmpty {
                        VStack(spacing: 16) {
                            Image(systemName: "photo.on.rectangle.angled")
                                .font(.system(size: 60))
                                .foregroundColor(.gray)
                            Text("No posts yet")
                                .font(.headline)
                                .foregroundColor(.secondary)
                            Text("Tap the + button\nto create your first post")
                                .font(.caption)
                                .foregroundColor(.secondary)
                                .multilineTextAlignment(.center)
                        }
                        .frame(maxWidth: .infinity, maxHeight: .infinity)
                        .padding(.top, 100)
                    } else {
                        // Posts Display - Grid or List mode
                        if showGridMode {
                            // Custom Grid View with alternating layout
                            CustomGridView(posts: viewModel.posts, showGridMode: $showGridMode, selectedPost: $selectedPost, navigateToSingleView: $navigateToSingleView)
                        } else {
                            // List View (default)
                            if let selectedPost = selectedPost {
                                // Show selected post first, then other posts
                                PostCardView(post: selectedPost, onLikeTapped: { post in
                                    Task {
                                        await viewModel.toggleLike(for: post)
                                    }
                                })
                                .id(selectedPost.id)
                                
                                // Show other posts below
                                ForEach(viewModel.posts.filter { $0.id != selectedPost.id }) { post in
                                    PostCardView(post: post, onLikeTapped: { post in
                                        Task {
                                            await viewModel.toggleLike(for: post)
                                        }
                                    })
                                }
                            } else {
                                // Show all posts
                                ForEach(viewModel.posts) { post in
                                    PostCardView(post: post, onLikeTapped: { post in
                                        Task {
                                            await viewModel.toggleLike(for: post)
                                        }
                                    })
                                }
                            }
                        }
                    }
                }
            }
            .coordinateSpace(name: "scroll")
            .refreshable {
                await viewModel.forceRefreshPosts()
            }
        }
        .navigationDestination(isPresented: $navigateToSingleView) {
            if let selectedPost = selectedPost {
                SinglePostView(
                    initialPost: selectedPost,
                    viewModel: viewModel,
                    showGridMode: $showGridMode
                )
                .onAppear {
                    isInSingleView = true
                }
                .onDisappear {
                    isInSingleView = false
                }
            }
        }
            
            // Floating Header
            VStack(spacing: 0) {
                UnifiedHeader(
                    title: "TETE",
                    rightButton: HeaderButton(
                        icon: "plus",
                        action: {
                            showingCreatePost = true
                        }
                    )
                )
                
                // Status Bar removed - handled by MainTabView
            }
            .offset(y: headerOffset)
            .zIndex(1000)
        }
        .ignoresSafeArea(.container, edges: [])
        .onAppear {
            print("üü¢ HomeFeedView appeared")
            Task {
                await viewModel.loadPostsIfNeeded()
            }
        }
        .onReceive(NotificationCenter.default.publisher(for: NSNotification.Name("PostCreated"))) { _ in
            print("üîÑ Post created notification received - refreshing feed")
            Task {
                await viewModel.forceRefreshPosts()
            }
        }
        .onChange(of: isInSingleView) { _, newValue in
            if !newValue && navigateToSingleView {
                // „Ç∑„É≥„Ç∞„É´„Éì„É•„Éº„Åã„ÇâÊàª„ÇãÊôÇ
                navigateToSingleView = false
                selectedPost = nil
            }
        }
        .onChange(of: showGridMode) { _, newValue in
            if newValue && isInSingleView {
                // „Ç∞„É™„ÉÉ„Éâ„É¢„Éº„Éâ„Å´Êàª„ÇãÊôÇ„Å´„Ç∑„É≥„Ç∞„É´„Éì„É•„Éº„Åã„Çâ„ÇÇÊàª„Çã
                navigateToSingleView = false
                selectedPost = nil
            }
        }
        // HomeFeedView„Åß„ÅÆÈÄöÁü•Âèó‰ø°„ÅØÁÑ°ÂäπÂåñÔºàMainTabView„ÅßÂá¶ÁêÜÔºâ
    }
    
    private func updateHeaderOffset(scrollOffset: CGFloat) {
        // „Ç∑„É≥„Éó„É´„Å™ÊñπÊ≥ï: Ë≤†„ÅÆÂÄ§Ôºà‰∏ä„Å´„Çπ„ÇØ„É≠„Éº„É´Ôºâ„Å´Âøú„Åò„Å¶„Éò„ÉÉ„ÉÄ„Éº„ÇíÈö†„Åô
        if scrollOffset < 0 {
            // ‰∏ã„Å´„Çπ„ÇØ„É≠„Éº„É´„Åó„ÅüÂ†¥ÂêàÔºàscrollOffset„ÅåË≤†„ÅÆÂÄ§Ôºâ
            let scrollDistance = abs(scrollOffset)
            headerOffset = -min(scrollDistance, headerHeight)
        } else {
            // ‰∏äÁ´Ø‰ªòËøë
            headerOffset = 0
        }
    }
}

// MARK: - Post Card View
struct PostCardView: View {
    let post: Post
    let onLikeTapped: (Post) -> Void
    
    var body: some View {
        VStack(spacing: 0) {
            // User Header
            HStack(spacing: 12) {
                // Avatar
                AsyncImage(url: URL(string: post.user?.avatarUrl ?? "")) { image in
                    image
                        .resizable()
                        .aspectRatio(contentMode: .fill)
                } placeholder: {
                    Circle()
                        .fill(Color(.tertiarySystemBackground))
                        .overlay(
                            Text(post.user?.username.prefix(1).uppercased() ?? "?")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        )
                }
                .frame(width: 32, height: 32)
                .clipShape(Circle())
                
                // User Info
                VStack(alignment: .leading, spacing: 2) {
                    Text(post.user?.username ?? "unknown_user")
                        .font(.body)
                        .fontWeight(.medium)
                        .foregroundColor(.primary)
                    
                    if let location = post.locationName {
                        Text(location)
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }
                
                Spacer()
                
                // Options
                Button(action: {}) {
                    Image(systemName: "ellipsis")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
            }
            .padding(.horizontal, 16)
            .padding(.vertical, 12)
            
            // Image
            AsyncImage(url: URL(string: post.mediaUrl)) { image in
                image
                    .resizable()
                    .aspectRatio(contentMode: .fill)
            } placeholder: {
                Rectangle()
                    .fill(Color(.tertiarySystemBackground))
            }
            .frame(maxHeight: 400)
            .clipped()
            
            // Actions
            HStack(spacing: 16) {
                // Like Button
                Button(action: { onLikeTapped(post) }) {
                    Image(systemName: post.isLikedByMe ? "heart.fill" : "heart")
                        .font(.system(size: 20, weight: .light))
                        .foregroundColor(post.isLikedByMe ? .red : .primary)
                }
                
                // Comment Button
                Button(action: {}) {
                    Image(systemName: "message")
                        .font(.system(size: 20, weight: .light))
                        .foregroundColor(.primary)
                }
                
                Spacer()
                
                // Time
                Text(timeAgoString(from: post.createdAt))
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
            .padding(.horizontal, 16)
            .padding(.vertical, 12)
            
            // Caption
            if let caption = post.caption, !caption.isEmpty {
                HStack {
                    Text(caption)
                        .font(.body)
                        .foregroundColor(.primary)
                        .lineLimit(3)
                        .multilineTextAlignment(.leading)
                    Spacer()
                }
                .padding(.horizontal, 16)
                .padding(.bottom, 12)
            }
        }
        .background(Color(.systemBackground))
    }
    
    private func timeAgoString(from date: Date) -> String {
        let formatter = RelativeDateTimeFormatter()
        formatter.unitsStyle = .abbreviated
        return formatter.localizedString(for: date, relativeTo: Date())
    }
}

// MARK: - Custom Grid View

struct CustomGridView: View {
    let posts: [Post]
    @Binding var showGridMode: Bool
    @Binding var selectedPost: Post?
    @Binding var navigateToSingleView: Bool
    
    var body: some View {
        LazyVStack(spacing: 1.5) {
            ForEach(0..<groupedPosts.count, id: \.self) { groupIndex in
                let group = groupedPosts[groupIndex]
                let isOddRow = groupIndex % 2 == 0
                
                if isOddRow {
                    // Â•áÊï∞ÊÆµ: Ê®™Èï∑ÂÜôÁúü1Êûö + Ê≠£ÊñπÂΩ¢ÂÜôÁúü1Êûö
                    OddRowView(posts: group) { post in
                        selectedPost = post
                        navigateToSingleView = true
                    }
                    .onAppear {
                        print("üé® Using OddRowView for group \(groupIndex) with \(group.count) posts")
                    }
                } else {
                    // ÂÅ∂Êï∞ÊÆµ: Ê≠£ÊñπÂΩ¢ÂÜôÁúü6Êûö
                    EvenRowView(posts: group) { post in
                        selectedPost = post
                        navigateToSingleView = true
                    }
                    .onAppear {
                        print("üé® Using EvenRowView for group \(groupIndex) with \(group.count) posts")
                    }
                }
            }
        }
    }
    
    private var groupedPosts: [[Post]] {
        return createOptimalGrid(from: posts)
    }
    
    /// „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Å´Âü∫„Å•„ÅÑ„Å¶ÊúÄÈÅ©„Å™„Ç∞„É™„ÉÉ„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÁîüÊàê
    private func createOptimalGrid(from posts: [Post]) -> [[Post]] {
        print("üîç CustomGridView: Creating grid for \(posts.count) posts")
        
        // „Éá„Éê„ÉÉ„Ç∞: ÂêÑÊäïÁ®ø„ÅÆ„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÇíË°®Á§∫
        for (index, post) in posts.enumerated() {
            let aspectRatio = post.aspectRatio
            let shouldDisplayAsLandscape = post.shouldDisplayAsLandscape
            print("üîç Post \(index): ID=\(post.id.prefix(8)), aspectRatio=\(aspectRatio?.description ?? "nil"), landscape=\(shouldDisplayAsLandscape)")
        }
        
        var groups: [[Post]] = []
        var currentIndex = 0
        
        while currentIndex < posts.count {
            let remainingPosts = posts.count - currentIndex
            
            // ÁèæÂú®‰ΩçÁΩÆ„Åã„ÇâÊúÄÈÅ©„Å™„Ç∞„É´„Éº„Éó„ÇíÊ±∫ÂÆö
            print("üîç Processing from index \(currentIndex), remaining: \(remainingPosts)")
            
            // „Åæ„Åö6Êûö‰ª•‰∏ä„ÅÇ„ÇãÂ†¥Âêà„ÅÆÂá¶ÁêÜ„ÇíÂÑ™ÂÖàÔºà„Çà„ÇäÂäπÁéáÁöÑ„Å™„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ
            if remainingPosts >= 6 {
                // 6Êûö‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÄÅÊúÄ„ÇÇÂé≥„Åó„ÅÑÊù°‰ª∂„ÅßÊ®™Èï∑ÂÜôÁúü„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                // 1ÊûöÁõÆ„ÅåÊ®™Èï∑„ÅÆÂ†¥Âêà„ÅÆ„ÅøÊ®™Èï∑„Ç∞„É´„Éº„Éó„Çí‰ΩúÊàê„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØÂÖ®„Å¶6Êûö„Ç∞„É´„Éº„Éó
                let firstPostIsLandscape = posts[currentIndex].shouldDisplayAsLandscape
                
                if firstPostIsLandscape {
                    // 1ÊûöÁõÆ„ÅåÊ®™Èï∑„ÅÆÂ†¥Âêà„ÅÆ„ÅøÊ®™Èï∑„Ç∞„É´„Éº„Éó„Çí‰ΩúÊàê
                    let group = createLandscapeGroup(startIndex: currentIndex, landscapeIndex: currentIndex, in: posts)
                    print("üîç Created landscape group with \(group.count) posts (first post is landscape)")
                    print("üîç Group posts: \(group.map { $0.id.prefix(8) })")
                    groups.append(group)
                    currentIndex += group.count
                } else {
                    // 1ÊûöÁõÆ„ÅåÊ≠£ÊñπÂΩ¢„ÅÆÂ†¥Âêà„ÅØÂøÖ„Åö6Êûö„Ç∞„É´„Éº„Éó„Çí‰ΩúÊàê
                    let group = Array(posts[currentIndex..<currentIndex + 6])
                    print("üîç Created 6-post square group (first post is not landscape)")
                    print("üîç Group posts: \(group.map { $0.id.prefix(8) })")
                    groups.append(group)
                    currentIndex += 6
                }
            } else if let landscapeIndex = findNextLandscapePost(from: currentIndex, in: posts, maxLookAhead: remainingPosts) {
                // 6ÊûöÊú™Ê∫Ä„ÅßÊ®™Èï∑ÂÜôÁúü„Åå„ÅÇ„ÇãÂ†¥Âêà
                let group = createLandscapeGroup(startIndex: currentIndex, landscapeIndex: landscapeIndex, in: posts)
                print("üîç Created landscape group with \(group.count) posts (landscape at index \(landscapeIndex))")
                print("üîç Group posts: \(group.map { $0.id.prefix(8) })")
                groups.append(group)
                currentIndex += group.count
            } else if remainingPosts >= 2 {
                // ÊÆã„Çä2-5Êûö„ÅÆÂ†¥Âêà„ÅØ2Êûö„Ç∞„É´„Éº„ÉóÔºàÊ®™Èï∑„Çπ„Çø„Ç§„É´Ôºâ
                let count = min(2, remainingPosts)
                let group = Array(posts[currentIndex..<currentIndex + count])
                print("üîç Created \(count)-post row group from index \(currentIndex)")
                print("üîç Group posts: \(group.map { $0.id.prefix(8) })")
                groups.append(group)
                currentIndex += count
            } else {
                // ÊÆã„Çä1Êûö„ÅÆÂ†¥Âêà
                let group = Array(posts[currentIndex..<currentIndex + 1])
                print("üîç Created single post group from index \(currentIndex)")
                print("üîç Group posts: \(group.map { $0.id.prefix(8) })")
                groups.append(group)
                currentIndex += 1
            }
        }
        
        print("üîç Final grid layout: \(groups.count) groups")
        return groups
    }
    
    /// ÊåáÂÆö„Åï„Çå„ÅüÁØÑÂõ≤ÂÜÖ„ÅßÊ¨°„ÅÆÊ®™Èï∑ÂÜôÁúü„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÊ§úÁ¥¢
    private func findNextLandscapePost(from startIndex: Int, in posts: [Post], maxLookAhead: Int) -> Int? {
        let endIndex = min(startIndex + maxLookAhead, posts.count)
        for i in startIndex..<endIndex {
            if posts[i].shouldDisplayAsLandscape {
                print("üîç Found landscape post at index \(i): \(posts[i].id.prefix(8))")
                return i
            }
        }
        print("üîç No landscape posts found in range \(startIndex)..<\(endIndex)")
        return nil
    }
    
    /// Ê®™Èï∑ÂÜôÁúü„ÇíÂê´„ÇÄ„Ç∞„É´„Éº„Éó„Çí‰ΩúÊàêÔºàÊ®™Èï∑ÂÜôÁúü„ÇíÊúÄÂàù„Å´ÈÖçÁΩÆÔºâ
    private func createLandscapeGroup(startIndex: Int, landscapeIndex: Int, in posts: [Post]) -> [Post] {
        var group: [Post] = []
        
        // Ê®™Èï∑ÂÜôÁúü„ÇíÊúÄÂàù„Å´ËøΩÂä†
        group.append(posts[landscapeIndex])
        
        // ÈñãÂßã„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åã„ÇâÊ®™Èï∑ÂÜôÁúü„Çà„ÇäÂâç„ÅÆÂÜôÁúü„ÇíËøΩÂä†
        for i in startIndex..<landscapeIndex {
            if group.count < 2 {
                group.insert(posts[i], at: 0)
            }
        }
        
        // Ê®™Èï∑ÂÜôÁúü„Çà„ÇäÂæå„ÅÆÂÜôÁúü„ÇíËøΩÂä†ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
        var nextIndex = landscapeIndex + 1
        while group.count < 2 && nextIndex < posts.count {
            group.append(posts[nextIndex])
            nextIndex += 1
        }
        
        return group
    }
}

// MARK: - Odd Row View (Ê®™Èï∑ + Ê≠£ÊñπÂΩ¢)

struct OddRowView: View {
    let posts: [Post]
    let onPostTapped: (Post) -> Void
    
    var body: some View {
        HStack(spacing: 1.5) {
            // ÊúÄÂàù„ÅÆÂÜôÁúüÔºà„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„Å´Âü∫„Å•„ÅÑ„Å¶Ë°®Á§∫Ôºâ
            if posts.count > 0 {
                let firstPost = posts[0]
                let isLandscape = firstPost.shouldDisplayAsLandscape
                
                if isLandscape {
                    // Ê®™Èï∑ÂÜôÁúü„ÅØÊ®™Èï∑„ÅßË°®Á§∫ (ÂπÖ„ÅØ2/3)
                    GridImageView(post: firstPost) {
                        onPostTapped(firstPost)
                    }
                    .frame(width: rectangleWidth, height: squareSize)
                    .clipped()
                    .background(Color.blue.opacity(0.1)) // „Éá„Éê„ÉÉ„Ç∞Áî®ËÉåÊôØËâ≤
                    .onAppear {
                        print("üé® OddRowView: First post \(firstPost.id.prefix(8)) isLandscape=\(isLandscape)")
                    }
                } else {
                    // Ê®™Èï∑„Åß„Å™„ÅÑÂÜôÁúü„ÅØÊ≠£ÊñπÂΩ¢„ÅßË°®Á§∫
                    GridImageView(post: firstPost) {
                        onPostTapped(firstPost)
                    }
                    .frame(width: squareSize, height: squareSize)
                    .clipped()
                    .aspectRatio(1, contentMode: .fill)
                    .background(Color.red.opacity(0.1)) // „Éá„Éê„ÉÉ„Ç∞Áî®ËÉåÊôØËâ≤
                    .onAppear {
                        print("üé® OddRowView: First post \(firstPost.id.prefix(8)) isLandscape=\(isLandscape)")
                    }
                }
            }
            
            // 2ÊûöÁõÆ„ÅÆÂÜôÁúüÔºàÂ∏∏„Å´Ê≠£ÊñπÂΩ¢Ôºâ
            if posts.count > 1 {
                let secondaryWidth = posts[0].shouldDisplayAsLandscape ? squareSize : rectangleWidth
                
                GridImageView(post: posts[1]) {
                    onPostTapped(posts[1])
                }
                .frame(width: secondaryWidth, height: squareSize)
                .clipped()
                .aspectRatio(1, contentMode: .fill)
                .background(Color.green.opacity(0.1)) // „Éá„Éê„ÉÉ„Ç∞Áî®ËÉåÊôØËâ≤
                .onAppear {
                    print("üé® OddRowView: Second post width=\(secondaryWidth)")
                }
            }
        }
        .frame(height: squareSize)
    }
    
    private var screenWidth: CGFloat {
        UIScreen.main.bounds.width
    }
    
    private var spacing: CGFloat {
        1.5
    }
    
    private var availableWidth: CGFloat {
        screenWidth - spacing // ‰∏≠Èñì„ÅÆ„Çπ„Éö„Éº„Çπ„ÅÆ„Åø
    }
    
    private var squareSize: CGFloat {
        availableWidth / 3 // 3Á≠âÂàÜ„Åó„Åü1„Å§ÂàÜ
    }
    
    private var rectangleWidth: CGFloat {
        squareSize * 2 // Ê≠£ÊñπÂΩ¢„ÅÆ2ÂÄç„ÅÆÂπÖ
    }
}

// MARK: - Even Row View (Ê≠£ÊñπÂΩ¢6Êûö)

struct EvenRowView: View {
    let posts: [Post]
    let onPostTapped: (Post) -> Void
    
    var body: some View {
        VStack(spacing: 1.5) {
            // ‰∏äÊÆµ3Êûö
            HStack(spacing: 1.5) {
                ForEach(0..<3, id: \.self) { index in
                    if index < posts.count {
                        GridImageView(post: posts[index]) {
                            onPostTapped(posts[index])
                        }
                        .frame(width: squareSize, height: squareSize)
                        .clipped()
                        .aspectRatio(1, contentMode: .fill)
                        .background(Color.yellow.opacity(0.1)) // „Éá„Éê„ÉÉ„Ç∞Áî®ËÉåÊôØËâ≤
                        .onAppear {
                            print("üé® EvenRowView: Top row index \(index) - Post \(posts[index].id.prefix(8))")
                        }
                    } else {
                        Rectangle()
                            .fill(Color(.tertiarySystemBackground))
                            .frame(width: squareSize, height: squareSize)
                            .onAppear {
                                print("üé® EvenRowView: Top row index \(index) - Empty placeholder")
                            }
                    }
                }
            }
            
            // ‰∏ãÊÆµ3Êûö
            HStack(spacing: 1.5) {
                ForEach(3..<6, id: \.self) { index in
                    if index < posts.count {
                        GridImageView(post: posts[index]) {
                            onPostTapped(posts[index])
                        }
                        .frame(width: squareSize, height: squareSize)
                        .clipped()
                        .aspectRatio(1, contentMode: .fill)
                        .background(Color.orange.opacity(0.1)) // „Éá„Éê„ÉÉ„Ç∞Áî®ËÉåÊôØËâ≤
                        .onAppear {
                            print("üé® EvenRowView: Bottom row index \(index) - Post \(posts[index].id.prefix(8))")
                        }
                    } else {
                        Rectangle()
                            .fill(Color(.tertiarySystemBackground))
                            .frame(width: squareSize, height: squareSize)
                            .onAppear {
                                print("üé® EvenRowView: Bottom row index \(index) - Empty placeholder")
                            }
                    }
                }
            }
        }
        .frame(height: totalHeight)
        .onAppear {
            print("üé® EvenRowView: Displaying \(posts.count) posts total")
        }
    }
    
    private var screenWidth: CGFloat {
        UIScreen.main.bounds.width
    }
    
    private var spacing: CGFloat {
        1.5
    }
    
    private var availableWidth: CGFloat {
        screenWidth - (spacing * 2) // ‰∏≠Èñì„ÅÆ„Çπ„Éö„Éº„Çπ2ÁÆáÊâÄ„ÅÆ„Åø
    }
    
    private var squareSize: CGFloat {
        availableWidth / 3 // 3Á≠âÂàÜ„Åó„Åü1„Å§ÂàÜÔºàÂ•áÊï∞ÊÆµ„ÅÆÊ≠£ÊñπÂΩ¢„Å®Âêå„Åò„Çµ„Ç§„Ç∫Ôºâ
    }
    
    private var totalHeight: CGFloat {
        squareSize * 2 + spacing // 2ÊÆµ + ‰∏≠Èñì„ÅÆ„Çπ„Éö„Éº„Ç∑„É≥„Ç∞
    }
}

// MARK: - Grid Image View

struct GridImageView: View {
    let post: Post
    let onTap: (() -> Void)?
    
    init(post: Post, onTap: (() -> Void)? = nil) {
        self.post = post
        self.onTap = onTap
    }
    
    var body: some View {
        Button(action: {
            onTap?()
        }) {
            // È´òÊÄßËÉΩ„Å™OptimizedAsyncImage„Çí‰ΩøÁî®
            OptimizedAsyncImage(urlString: post.mediaUrl) { phase in
                switch phase {
                case .success(let image):
                    image
                        .resizable()
                        .aspectRatio(contentMode: .fill)
                case .failure(_):
                    Rectangle()
                        .fill(Color(.tertiarySystemBackground))
                        .overlay(
                            Image(systemName: "photo")
                                .font(.title3)
                                .foregroundColor(.secondary)
                        )
                case .empty:
                    Rectangle()
                        .fill(Color(.tertiarySystemBackground))
                        .overlay(
                            ProgressView()
                                .tint(.secondary)
                        )
                @unknown default:
                    Rectangle()
                        .fill(Color(.tertiarySystemBackground))
                }
            }
        }
        .buttonStyle(PlainButtonStyle())
    }
}

struct HomeFeedView_Previews: PreviewProvider {
    static var previews: some View {
        HomeFeedView(
            showGridMode: .constant(false), 
            showingCreatePost: .constant(false),
            isInSingleView: .constant(false),
            onBackToGrid: nil
        )
    }
}